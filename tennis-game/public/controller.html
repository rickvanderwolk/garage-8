<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Tennis Game Controller</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Courier New', monospace;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: #fff;
      overflow: hidden;
      height: 100vh;
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
    }

    #controller-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .controller-screen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      width: 100%;
      max-width: 500px;
    }

    .controller-screen.active {
      display: flex;
    }

    .status-icon {
      font-size: 60px;
      margin-bottom: 15px;
    }

    h2 {
      font-size: 24px;
      margin-bottom: 10px;
    }

    p {
      font-size: 16px;
      color: #aaa;
      margin-bottom: 8px;
    }

    .big-button {
      font-family: 'Courier New', monospace;
      font-size: 18px;
      padding: 18px 35px;
      background: #4CAF50;
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      text-transform: uppercase;
      margin-top: 20px;
      transition: all 0.3s;
    }

    .big-button:active {
      transform: scale(0.95);
      background: #45a049;
    }

    .team-badge {
      display: inline-block;
      padding: 12px 30px;
      font-size: 24px;
      font-weight: bold;
      border-radius: 10px;
      margin-bottom: 15px;
      border: 3px solid;
    }

    .team-badge.team-left {
      background: rgba(255, 68, 68, 0.2);
      border-color: #ff4444;
      color: #ff4444;
    }

    .team-badge.team-right {
      background: rgba(68, 68, 255, 0.2);
      border-color: #4444ff;
      color: #4444ff;
    }

    #paddle-info {
      font-size: 18px;
      color: #fff;
      margin-bottom: 20px;
    }

    #calibration-zone {
      width: 100%;
      max-width: 350px;
      margin: 20px 0;
    }

    .tilt-display {
      background: #111;
      border: 2px solid #333;
      border-radius: 10px;
      padding: 20px 15px;
      margin-bottom: 15px;
      position: relative;
      height: 80px;
    }

    #tilt-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 15px;
      height: 50px;
      background: #4CAF50;
      border-radius: 8px;
      transition: left 0.1s ease-out;
      box-shadow: 0 0 15px #4CAF50;
    }

    .tilt-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 11px;
      color: #666;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .control-button {
      font-family: 'Courier New', monospace;
      font-size: 14px;
      padding: 12px 25px;
      background: #333;
      color: #fff;
      border: 2px solid #555;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      text-transform: uppercase;
      transition: all 0.3s;
    }

    .control-button:active {
      transform: scale(0.95);
      background: #444;
    }

    .sensitivity-control {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background: #111;
      border: 2px solid #333;
      border-radius: 8px;
    }

    .sensitivity-control label {
      font-size: 12px;
      color: #aaa;
    }

    .sensitivity-control input[type="range"] {
      flex: 1;
      height: 6px;
      background: #333;
      outline: none;
      border-radius: 3px;
    }

    .sensitivity-control input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: #4CAF50;
      cursor: pointer;
      border-radius: 50%;
    }

    #sensitivity-value {
      font-weight: bold;
      color: #4CAF50;
      min-width: 25px;
      text-align: right;
      font-size: 14px;
    }

    #game-status {
      margin: 20px 0;
    }

    #status-text {
      font-size: 20px;
      font-weight: bold;
      color: #666;
      transition: all 0.3s;
    }

    #status-text.active {
      color: #4CAF50;
      text-shadow: 0 0 10px #4CAF50;
    }

    .instructions {
      margin-top: 20px;
      padding: 15px;
      background: #111;
      border: 2px solid #333;
      border-radius: 10px;
      max-width: 350px;
    }

    .instructions h3 {
      font-size: 16px;
      margin-bottom: 10px;
      color: #4CAF50;
    }

    .instructions p {
      font-size: 13px;
      color: #aaa;
      margin-bottom: 6px;
    }

    .debug {
      position: fixed;
      bottom: 10px;
      left: 10px;
      font-size: 10px;
      color: #666;
      background: rgba(0,0,0,0.5);
      padding: 5px;
      border-radius: 3px;
    }
  </style>
</head>
<body class="controller-body">
  <div id="controller-container">
    <!-- Connecting Screen -->
    <div id="connecting" class="controller-screen active">
      <div class="status-icon">üì±</div>
      <h2>Connecting...</h2>
      <p>Please wait</p>
    </div>

    <!-- Permission Screen (iOS) -->
    <div id="permission" class="controller-screen">
      <div class="status-icon">üîê</div>
      <h2>Motion Permission</h2>
      <p>We need access to your device's motion sensors</p>
      <button id="permission-button" class="big-button">ALLOW MOTION</button>
    </div>

    <!-- Connected Screen -->
    <div id="connected" class="controller-screen">
      <div id="team-indicator" class="team-badge"></div>
      <p id="paddle-info">Paddle #1</p>

      <div id="calibration-zone">
        <div class="tilt-display">
          <div id="tilt-indicator"></div>
          <div class="tilt-labels">
            <span>LEFT</span>
            <span>CENTER</span>
            <span>RIGHT</span>
          </div>
        </div>
        <div class="controls">
          <button id="calibrate-button" class="control-button">CALIBRATE</button>
          <div class="sensitivity-control">
            <label>Sens.</label>
            <input type="range" id="sensitivity" min="1" max="5" value="3" step="0.5">
            <span id="sensitivity-value">3</span>
          </div>
        </div>
      </div>

      <div id="game-status">
        <p id="status-text">Waiting for game...</p>
      </div>

      <div class="instructions">
        <h3>How to play:</h3>
        <p>Tilt phone left/right to move</p>
        <p>Keep phone upright (portrait)</p>
      </div>
    </div>

    <!-- Error Screen -->
    <div id="error" class="controller-screen">
      <div class="status-icon">‚ùå</div>
      <h2>Error</h2>
      <p id="error-message">Connection error</p>
      <button id="retry-button" class="big-button">RETRY</button>
    </div>
  </div>

  <div id="debug" class="debug"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // Screen elements
    const screens = {
      connecting: document.getElementById('connecting'),
      permission: document.getElementById('permission'),
      connected: document.getElementById('connected'),
      error: document.getElementById('error')
    };

    // UI elements
    const permissionButton = document.getElementById('permission-button');
    const calibrateButton = document.getElementById('calibrate-button');
    const retryButton = document.getElementById('retry-button');
    const teamIndicator = document.getElementById('team-indicator');
    const paddleInfo = document.getElementById('paddle-info');
    const statusText = document.getElementById('status-text');
    const tiltIndicator = document.getElementById('tilt-indicator');
    const sensitivitySlider = document.getElementById('sensitivity');
    const sensitivityValue = document.getElementById('sensitivity-value');
    const errorMessage = document.getElementById('error-message');
    const debugEl = document.getElementById('debug');

    // Controller state
    let team = null;
    let paddleIndex = null;
    let calibrationOffset = 0;
    let sensitivity = 3;
    let isTracking = false;
    let wakeLock = null;
    let noSleepVideo = null;
    let noSleepAudio = null;

    // Debug logging
    function debug(msg) {
      console.log(msg);
      debugEl.textContent = msg;
    }

    // Show screen
    function showScreen(screenName) {
      Object.values(screens).forEach(s => s.classList.remove('active'));
      if (screens[screenName]) {
        screens[screenName].classList.add('active');
      }
    }

    // Show error
    function showError(msg) {
      errorMessage.textContent = msg;
      showScreen('error');
    }

    // Enable wake lock to prevent screen from sleeping
    async function enableWakeLock() {
      try {
        // Try modern Wake Lock API first (Chrome, Edge, Safari 16.4+)
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
          debug('Wake Lock enabled (API)');

          wakeLock.addEventListener('release', () => {
            debug('Wake Lock released');
          });

          // Re-acquire wake lock when page becomes visible again
          document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
              try {
                wakeLock = await navigator.wakeLock.request('screen');
                debug('Wake Lock re-acquired');
              } catch (err) {
                debug(`Wake Lock re-acquire failed: ${err.message}`);
              }
            }
          });
        } else {
          debug('Wake Lock API not supported, using video fallback');
        }

        // Always use video fallback for iOS (even with Wake Lock API)
        // iOS is very restrictive and the video method is more reliable
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        if (isIOS || !('wakeLock' in navigator)) {
          debug('Enabling video fallback for iOS');
          noSleepVideo = document.createElement('video');
          noSleepVideo.setAttribute('playsinline', '');
          noSleepVideo.setAttribute('muted', '');
          noSleepVideo.setAttribute('loop', '');
          noSleepVideo.style.position = 'fixed';
          noSleepVideo.style.width = '1px';
          noSleepVideo.style.height = '1px';
          noSleepVideo.style.opacity = '0.01';
          noSleepVideo.style.pointerEvents = 'none';
          noSleepVideo.style.left = '-9999px';

          // Tiny base64 encoded looping video
          noSleepVideo.src = 'data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAAu1tZGF0AAACrgYF//+q3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE0OCByMjc0MyA1YzY1NzA0IC0gSC4yNjQvTVBFRy00IEFWQyBjb2RlYyAtIENvcHlsZWZ0IDIwMDMtMjAxNiAtIGh0dHA6Ly93d3cudmlkZW9sYW4ub3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjPTEgcmVmPTMgZGVibG9jaz0xOjA6MCBhbmFseXNlPTB4MzoweDExMyBtZT1oZXggc3VibWU9NyBwc3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVkX3JlZj0xIG1lX3JhbmdlPTE2IGNocm9tYV9tZT0xIHRyZWxsaXM9MSA4eDhkY3Q9MSBjcW09MCBkZWFkem9uZT0yMSwxMSBmYXN0X3Bza2lwPTEgY2hyb21hX3FwX29mZnNldD0tMiB0aHJlYWRzPTEgbG9va2FoZWFkX3RocmVhZHM9MSBzbGljZWRfdGhyZWFkcz0wIG5yPTAgZGVjaW1hdGU9MSBpbnRlcmxhY2VkPTAgYmx1cmF5X2NvbXBhdD0wIGNvbnN0cmFpbmVkX2ludHJhPTAgYmZyYW1lcz0zIGJfcHlyYW1pZD0yIGJfYWRhcHQ9MSBiX2JpYXM9MCBkaXJlY3Q9MSB3ZWlnaHRiPTEgb3Blbl9nb3A9MCB3ZWlnaHRwPTIga2V5aW50PTI1MCBrZXlpbnRfbWluPTI1IHNjZW5lY3V0PTQwIGludHJhX3JlZnJlc2g9MCByY19sb29rYWhlYWQ9NDAgcmM9Y3JmIG1idHJlZT0xIGNyZj0yMy4wIHFjb21wPTAuNjAgcXBtaW49MCBxcG1heD02OSBxcHN0ZXA9NCBpcF9yYXRpbz0xLjQwIGFxPTE6MS4wMACAAAABWGWIhAA3//728P4FNjuY0JcRzeidMx+/Fbi6NDe9zgAAAwAAAwAAAwAAAwAAAwAAAwAAFgn0I7DkqgN3QKAApXH3P/3VdF3h4Pl0HzIl2hCgzFEgAAAAGEGaIWxDf/6nhAAAAwAAAwAAAwAAFzgAAAAIQZ5CeIK/AAADAAAABUGEQAHSAAADAAAAA0GEhAAAAwAA';

          document.body.appendChild(noSleepVideo);

          // Play video - must be in response to user interaction on iOS
          try {
            await noSleepVideo.play();
            debug('Video wake lock playing');
          } catch (err) {
            debug(`Video play error: ${err.message}`);
          }

          // Keep video playing even if it stops
          noSleepVideo.addEventListener('pause', () => {
            debug('Video paused, restarting...');
            noSleepVideo.play().catch(e => debug(`Video restart failed: ${e.message}`));
          });

          // Also use silent audio for iOS Safari (most reliable method)
          noSleepAudio = document.createElement('audio');
          noSleepAudio.setAttribute('loop', '');
          noSleepAudio.setAttribute('playsinline', '');
          noSleepAudio.style.display = 'none';

          // Silent audio file (1 second of silence)
          noSleepAudio.src = 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAADhAC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjU0AAAAAAAAAAAAAAAAJAAAAAAAAAAAd4QgeZ0AAAAAAAD/+xDEAAP8A8AAABpAAAACAAADSAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//sQxAAAAAA0gAAAAAAAADSAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/7EMQAAAAAANIAAAAAAAABpAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==';

          document.body.appendChild(noSleepAudio);

          try {
            await noSleepAudio.play();
            debug('Audio wake lock playing');
          } catch (err) {
            debug(`Audio play error: ${err.message}`);
          }

          // Keep audio playing
          noSleepAudio.addEventListener('pause', () => {
            debug('Audio paused, restarting...');
            noSleepAudio.play().catch(e => debug(`Audio restart failed: ${e.message}`));
          });
        }
      } catch (err) {
        debug(`Wake Lock setup failed: ${err.message}`);
      }
    }

    // Disable wake lock
    function disableWakeLock() {
      if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
        debug('Wake Lock disabled');
      }
      if (noSleepVideo) {
        noSleepVideo.pause();
        noSleepVideo.remove();
        noSleepVideo = null;
        debug('Video wake lock disabled');
      }
      if (noSleepAudio) {
        noSleepAudio.pause();
        noSleepAudio.remove();
        noSleepAudio = null;
        debug('Audio wake lock disabled');
      }
    }

    // Request permission and start tracking
    function requestPermission() {
      debug('Requesting permission...');

      if (typeof DeviceOrientationEvent === 'undefined') {
        showError('Device does not support motion sensors');
        return;
      }

      // Check if permission is needed (iOS 13+)
      if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        debug('iOS device - showing permission button');
        showScreen('permission');

        // Remove old listener
        const newButton = permissionButton.cloneNode(true);
        permissionButton.parentNode.replaceChild(newButton, permissionButton);

        newButton.addEventListener('click', async () => {
          debug('Permission button clicked');
          try {
            const permission = await DeviceOrientationEvent.requestPermission();
            debug(`Permission result: ${permission}`);

            if (permission === 'granted') {
              startTracking();
              showScreen('connected');
            } else {
              showError('Motion permission denied');
            }
          } catch (err) {
            debug(`Permission error: ${err.message}`);
            showError('Could not get permission: ' + err.message);
          }
        });
      } else {
        // Non-iOS or older iOS
        debug('Non-iOS device - starting directly');
        startTracking();
        showScreen('connected');
      }
    }

    // Start motion tracking
    function startTracking() {
      if (isTracking) return;

      debug('Starting motion tracking');
      isTracking = true;
      window.addEventListener('deviceorientation', handleOrientation);

      // Test if events are firing
      setTimeout(() => {
        if (!isTracking) {
          debug('No orientation events received');
        }
      }, 2000);
    }

    // Handle device orientation
    function handleOrientation(event) {
      if (!team) return;

      // gamma: left/right tilt (-90 to 90)
      let gamma = event.gamma;

      if (gamma === null || gamma === undefined) {
        debug('Gamma is null');
        return;
      }

      debug(`Gamma: ${gamma.toFixed(1)}`);

      // Apply calibration
      gamma -= calibrationOffset;

      // Apply sensitivity
      gamma *= (sensitivity / 3);

      // Normalize to 0-1 range
      const maxTilt = 45;
      let position = (gamma + maxTilt) / (maxTilt * 2);
      position = Math.max(0, Math.min(1, position));

      // Update visual indicator
      const indicatorPosition = position * 100;
      tiltIndicator.style.left = `${indicatorPosition}%`;

      // Send to server
      socket.emit('paddleMove', { position });
    }

    // Calibrate
    calibrateButton.addEventListener('click', () => {
      const handler = (event) => {
        calibrationOffset = event.gamma || 0;
        calibrateButton.textContent = 'CALIBRATED ‚úì';
        debug(`Calibrated to: ${calibrationOffset.toFixed(1)}`);
        setTimeout(() => {
          calibrateButton.textContent = 'CALIBRATE';
        }, 1500);
      };
      window.addEventListener('deviceorientation', handler, { once: true });
    });

    // Sensitivity control
    sensitivitySlider.addEventListener('input', (e) => {
      sensitivity = parseFloat(e.target.value);
      sensitivityValue.textContent = sensitivity.toFixed(1);
    });

    // Socket events
    socket.on('connect', () => {
      debug('Connected to server');
      socket.emit('joinGame');
    });

    socket.on('teamAssigned', (data) => {
      debug(`Assigned to ${data.team} team`);
      team = data.team;
      paddleIndex = data.paddleIndex;

      teamIndicator.textContent = `${team.toUpperCase()} TEAM`;
      teamIndicator.className = `team-badge team-${team}`;
      paddleInfo.textContent = `Paddle #${paddleIndex + 1}`;

      requestPermission();

      // Enable wake lock to keep screen on
      enableWakeLock();
    });

    socket.on('gameStarted', () => {
      statusText.textContent = 'GAME IN PROGRESS!';
      statusText.classList.add('active');
    });

    socket.on('score', (data) => {
      if (data.team === team) {
        statusText.textContent = 'GOAL! üéâ';
        setTimeout(() => {
          statusText.textContent = 'GAME IN PROGRESS!';
        }, 2000);
      }
    });

    socket.on('gameOver', (data) => {
      statusText.classList.remove('active');
      if (data.winner === team) {
        statusText.textContent = 'üèÜ YOU WON! üèÜ';
        statusText.style.color = '#4CAF50';
      } else if (data.winner === 'draw') {
        statusText.textContent = 'DRAW!';
        statusText.style.color = '#FFC107';
      } else {
        statusText.textContent = 'YOU LOST';
        statusText.style.color = '#f44336';
      }
    });

    socket.on('disconnect', () => {
      disableWakeLock();
      showError('Disconnected from server');
    });

    socket.on('connect_error', () => {
      showError('Could not connect to server');
    });

    // Retry
    retryButton.addEventListener('click', () => {
      location.reload();
    });

    // Prevent scrolling
    document.addEventListener('touchmove', (e) => {
      e.preventDefault();
    }, { passive: false });

    document.addEventListener('gesturestart', (e) => {
      e.preventDefault();
    });
  </script>
</body>
</html>
